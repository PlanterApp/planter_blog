{{- $cover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
{{ $coverUrl := printf "%s%s" "https://blog.planter.garden" (print (.Params.cover.image)) }}
{{- if $cover }}
  {{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif") -}}
  {{- if hugo.IsExtended -}}
    {{- $processableFormats = $processableFormats | append "webp" -}}
  {{- end -}}
  {{- $size := "480" }}
  {{- $prod := (hugo.IsProduction | or (eq .Page.Site.Params.env "production")) }}
  {{- if (and $cover (in $processableFormats $cover.MediaType.SubType) (eq $prod true)) }}
    {{- if (ge $cover.Width $size) -}}
      {{ $coverUrl = (($cover.Resize (printf "%sx webp" $size)).Permalink) -}}
    {{ end }}
  {{- end -}}
{{- end }}
{{- $content := .Plain | truncate 500 | jsonify }}

{
  "title": {{ .Title | jsonify }},
  "author": {{ .Params.author | jsonify }},
  "image": {
    "url": "{{ $coverUrl }}",
    "caption" : {{ .Params.cover.caption | jsonify }},
    "alt" : {{ .Params.cover.alt | jsonify }}
  },
  "date" : "{{ .Params.date }}",
  "permalink" : {{ .Permalink | jsonify }},
  "content" : {{ $content }}
}
